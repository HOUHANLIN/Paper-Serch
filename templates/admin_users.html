{% extends "_base.html" %}

{% block title %}Paper-Serch · 管理面板{% endblock %}

{% block content %}
  <section class="container" style="max-width: 1100px;">
    <div class="card">
      <div class="card-head">
        <div>
          <p class="card-kicker">ADMIN</p>
          <h2>账户管理</h2>
        </div>
      </div>
      {% if error %}
        <div class="alert error" style="margin-bottom: 12px;">{{ error }}</div>
      {% endif %}
      {% if message %}
        <div class="alert success" style="margin-bottom: 12px;">{{ message }}</div>
      {% endif %}
      <p class="muted" style="margin: 0;">仅管理员可见：用于创建新账号、调整余额与切换管理员权限。</p>
    </div>

    <div class="card" style="margin-top: 16px;">
      <div class="card-head">
        <div>
          <p class="card-kicker">CREATE</p>
          <h2>创建新账号</h2>
        </div>
      </div>
      <form method="post" class="stack">
        <input type="hidden" name="action" value="create" />
        <div class="field-row">
          <div class="field">
            <label for="new-email">邮箱</label>
            <input id="new-email" name="email" type="email" required />
          </div>
          <div class="field">
            <label for="new-password">初始密码</label>
            <input id="new-password" name="password" type="password" minlength="6" required />
          </div>
        </div>
        <div class="field-row">
          <div class="field">
            <label for="initial-credits">初始余额</label>
            <input id="initial-credits" name="initial_credits" type="number" min="0" value="{{ initial_credits or 3 }}" />
          </div>
          <div class="field">
            <label class="switch" for="is-admin">
              <input id="is-admin" name="is_admin" type="checkbox" value="1" />
              <span>授予管理员权限</span>
            </label>
          </div>
        </div>
        <div class="field-row">
          <div class="field">
            <label for="new-ai-provider">AI Provider</label>
            <select id="new-ai-provider" name="ai_provider">
              <option value="">默认（环境预设）</option>
              <option value="openai">OpenAI</option>
              <option value="gemini">Gemini</option>
            </select>
          </div>
          <div class="field" style="flex: 2;">
            <label for="new-ai-model">模型名称</label>
            <input id="new-ai-model" name="ai_model" type="text" placeholder="留空使用默认模型" />
          </div>
        </div>
        <div class="field-row">
          <div class="field" style="flex: 2;">
            <label for="new-ai-base-url">Base URL</label>
            <input id="new-ai-base-url" name="ai_base_url" type="text" placeholder="留空从环境变量读取（OpenAI 可用）" />
          </div>
          <div class="field" style="flex: 2;">
            <label for="new-ai-api-key">API Key</label>
            <input id="new-ai-api-key" name="ai_api_key" type="password" placeholder="留空从环境变量读取" />
          </div>
        </div>
        <div class="actions">
          <button class="btn primary" type="submit">创建账号</button>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top: 16px;">
      <div class="card-head">
        <div>
          <p class="card-kicker">USERS</p>
          <h2>用户列表</h2>
        </div>
      </div>
      {% if users and users|length %}
        <div class="stack">
          {% for user in users %}
            <div class="card" style="padding: 12px; margin: 0;">
              <div class="field-row" style="align-items: center;">
                <div class="field" style="flex: 2;">
                  <label>邮箱</label>
                  <div class="muted">{{ user.email }}</div>
                </div>
                <div class="field" style="flex: 1;">
                  <label>余额</label>
                  <div class="muted">
                    {% if user.is_admin or user.credits_unlimited %}管理员{% else %}{{ user.credits_balance }}{% endif %}
                  </div>
                </div>
                <div class="field" style="flex: 2;">
                  <label>AI 模型</label>
                  <div class="muted">
                    {% if user.ai_provider %}
                      {{ user.ai_provider }}{% if user.ai_model %} · {{ user.ai_model }}{% endif %}
                    {% else %}
                      默认（跟随环境预设）
                    {% endif %}
                  </div>
                </div>
                <div class="field" style="flex: 1;">
                  <label>管理员</label>
                  <div class="muted">{{ '是' if user.is_admin else '否' }}</div>
                </div>
                <div class="field" style="flex: 1;">
                  <label>创建时间</label>
                  <div class="muted">{{ user.created_at }}</div>
                </div>
              </div>
              <div class="muted" style="margin-top: 8px;">
                工作流限额：方向 ≤ {{ user.workflow_max_directions or 6 }}，每方向 ≤ {{ user.workflow_max_results_per_direction or 3 }}
              </div>
              <div class="field-row" style="margin-top: 8px; gap: 12px; align-items: flex-end;">
                <form method="post" class="field-row" style="gap: 8px; flex: 2;">
                  <input type="hidden" name="action" value="adjust" />
                  <input type="hidden" name="user_id" value="{{ user.id }}" />
                  <div class="field">
                    <label for="delta-{{ user.id }}">调整余额（可为负数）</label>
                    <input id="delta-{{ user.id }}" name="delta" type="number" step="1" value="0" />
                  </div>
                  <div class="field">
                    <label for="reason-{{ user.id }}">备注</label>
                    <input id="reason-{{ user.id }}" name="reason" type="text" placeholder="admin_adjustment" />
                  </div>
                  <div class="field" style="min-width: 120px;">
                    <button class="btn subtle" type="submit">更新余额</button>
                  </div>
                </form>
                <form method="post" class="field" style="flex: 1; text-align: right;">
                  <input type="hidden" name="action" value="toggle_admin" />
                  <input type="hidden" name="user_id" value="{{ user.id }}" />
                  <input type="hidden" name="make_admin" value="{{ 0 if user.is_admin else 1 }}" />
                  <button class="btn ghost" type="submit" {% if user.id == current_user.id and user.is_admin %}disabled{% endif %}>
                    {% if user.is_admin %}移除管理员{% else %}设为管理员{% endif %}
                  </button>
                </form>
              </div>
              <form method="post" class="field-row" style="margin-top: 10px; gap: 8px; align-items: flex-end;">
                <input type="hidden" name="action" value="set_ai" />
                <input type="hidden" name="user_id" value="{{ user.id }}" />
                <div class="field" style="flex: 1;">
                  <label for="ai-provider-{{ user.id }}">Provider</label>
                  <select id="ai-provider-{{ user.id }}" name="ai_provider">
                    <option value="" {% if not user.ai_provider %}selected{% endif %}>默认（环境预设）</option>
                    <option value="openai" {% if user.ai_provider == 'openai' %}selected{% endif %}>OpenAI</option>
                    <option value="gemini" {% if user.ai_provider == 'gemini' %}selected{% endif %}>Gemini</option>
                  </select>
                </div>
                <div class="field" style="flex: 2;">
                  <label for="ai-model-{{ user.id }}">模型名称</label>
                  <input id="ai-model-{{ user.id }}" name="ai_model" type="text" value="{{ user.ai_model or '' }}" placeholder="留空使用 Provider 默认模型" />
                </div>
                <div class="field" style="flex: 2;">
                  <label for="ai-base-url-{{ user.id }}">Base URL</label>
                  <input
                    id="ai-base-url-{{ user.id }}"
                    name="ai_base_url"
                    type="text"
                    value="{{ user.ai_base_url or '' }}"
                    placeholder="留空从环境变量读取（OpenAI 可用）"
                  />
                </div>
                <div class="field" style="flex: 2;">
                  <label for="ai-api-key-{{ user.id }}">API Key</label>
                  <input
                    id="ai-api-key-{{ user.id }}"
                    name="ai_api_key"
                    type="password"
                    value="{{ user.ai_api_key or '' }}"
                    placeholder="留空从环境变量读取"
                  />
                </div>
                <div class="field" style="min-width: 120px;">
                  <button class="btn subtle" type="submit">更新 AI</button>
                </div>
              </form>
              <form method="post" class="field-row" style="margin-top: 10px; gap: 8px; align-items: flex-end;">
                <input type="hidden" name="action" value="set_limits" />
                <input type="hidden" name="user_id" value="{{ user.id }}" />
                <div class="field" style="flex: 1;">
                  <label for="max-dirs-{{ user.id }}">方向上限</label>
                  <input
                    id="max-dirs-{{ user.id }}"
                    name="workflow_max_directions"
                    type="number"
                    min="1"
                    max="12"
                    value="{{ user.workflow_max_directions or 6 }}"
                  />
                </div>
                <div class="field" style="flex: 1;">
                  <label for="max-results-{{ user.id }}">每方向文献上限</label>
                  <input
                    id="max-results-{{ user.id }}"
                    name="workflow_max_results_per_direction"
                    type="number"
                    min="1"
                    max="50"
                    value="{{ user.workflow_max_results_per_direction or 3 }}"
                  />
                </div>
                <div class="field" style="min-width: 120px;">
                  <button class="btn subtle" type="submit">更新限额</button>
                </div>
              </form>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">暂无用户。</div>
      {% endif %}
    </div>
  </section>
{% endblock %}
