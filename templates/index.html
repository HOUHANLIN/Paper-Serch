{% extends "_base.html" %}

{% block title %}Paper-Serch · 文献检索与 BibTeX 导出{% endblock %}

{% block content %}
  <section class="hero container">
    <div class="hero-text">
      <p class="eyebrow">温暖简约 · 日夜双模</p>
      <h1>轻松检索并整理你的文献</h1>
      <p class="lede">紧凑的界面与柔和配色，快速选择模型与数据源，随时导出 BibTeX。</p>
    </div>
    {% set placeholder_detail = '提交后在此显示实时进度。' %}
    {% include "_partials/status_module.html" %}
  </section>

  <form id="search-form" method="post" class="container workflow-layout">
    <aside class="workflow-settings stack">
      <details class="card settings-collapsible" open>
        <summary class="card-head">
          <div>
            <p class="card-kicker">CONFIGURATION</p>
            <h2>配置与工具</h2>
          </div>
        </summary>

        <div class="settings-content stack">
          {% if allow_ai_config %}
            {% include "_partials/provider_panels.html" %}
          {% else %}
            {% include "_partials/preset_ai_notice.html" %}
          {% endif %}

          <hr class="separator" />

          <div class="field-row">
            <div class="field">
              <label for="source">数据源</label>
              <select id="source" name="source">
                {% for source in sources %}
                  <option value="{{ source.name }}" {% if form.source==source.name %}selected{% endif %}>{{ source.display_name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="field">
              <label for="years">年份</label>
              <input id="years" name="years" type="number" min="1" max="50" value="{{ form.years }}" />
            </div>
          </div>

          <div class="field">
            <label for="max_results">最大条数</label>
            <input id="max_results" name="max_results" type="number" min="1" max="200" value="{{ form.max_results }}" />
          </div>

          <div class="field">
            <label class="switch">
              <input type="checkbox" id="toggle-contact" />
              <span>高级参数</span>
            </label>
          </div>

          <div id="contact-fields" style="display:none;" class="stack">
            <div class="field"><label for="email">联系邮箱</label><input id="email" name="email" type="text" value="{{ form.email }}" /></div>
            <div class="field"><label for="api_key">API Key</label><input id="api_key" name="api_key" type="text" value="{{ form.api_key }}" /></div>
          </div>
        </div>
      </details>
    </aside>

    <div class="workflow-main stack">
      <div class="card workspace-card">
        <div class="card-head">
          <div>
            <p class="card-kicker">SEARCH</p>
            <h2>文献检索</h2>
          </div>
        </div>
        <div class="field">
          <textarea id="query" name="query" placeholder="输入 PubMed 检索式..." class="large-input">{{ form.query }}</textarea>
        </div>

        <div class="ai-assist-section">
          <details class="subtle-details">
            <summary>需要 AI 协助生成检索式？</summary>
            <div class="stack pt-10">
              <label for="intent" class="muted">用自然语言描述需求</label>
              <textarea id="intent" name="intent" placeholder="例如：检索最近 5 年关于肺癌免疫治疗的 Meta 分析..."></textarea>
              <div class="generator">
                <button class="btn ghost" id="btn-generate-query" type="button">AI 生成检索式</button>
                <div class="generator-preview" id="generator-preview"></div>
                <div class="generator-actions" id="generator-actions">
                  <button class="btn subtle" id="btn-apply-query" type="button">应用到检索式</button>
                  <span id="generator-message" class="muted">生成的检索式会显示在这里。</span>
                </div>
              </div>
            </div>
          </details>
        </div>

        <div class="generator-actions mt-20">
          <button class="btn primary large" id="submit-btn" type="submit">开始检索并生成 BibTeX</button>
          <input id="output" name="output" type="hidden" value="{{ form.output }}" />
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <p class="card-kicker">PAPERS</p>
            <h2>文献列表</h2>
          </div>
        </div>
        {% include "_partials/article_list.html" %}
      </div>

      {% set bibtex_form_id = 'search-form' %}
      {% include "_partials/bibtex_card.html" %}
    </div>
  </form>

  <footer class="footer">
    <div class="container">
      <p class="muted">LOCAL RESEARCH UTILITY</p>
      <p>界面仅作为本地学术辅助工具使用：不会上传你的 API Key 或检索式到除必要接口以外的任何服务。</p>
    </div>
  </footer>
{% endblock %}
