<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>Paper-Serch · 文献检索与 BibTeX 导出</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  </head>
  <body>
    <div class="shell">
      <header class="topbar">
        <div class="topbar-inner">
          <div class="brand">
            <div class="brand-mark"></div>
            <div>
              <div class="brand-text-sub">Paper-Serch</div>
              <div class="brand-text-main">Literature &amp; AI summaries</div>
            </div>
          </div>
          <div class="topbar-nav">
            <a class="topbar-link" href="{{ url_for('index') }}">首页</a>
            <a class="topbar-link" href="{{ url_for('tutorial') }}">使用教程</a>
          </div>
          <div class="topbar-right">RESEARCH REFERENCES · PERSONAL TOOL</div>
        </div>
      </header>

      <main class="page">
        <div class="headline">
          <div class="headline-pill">
            <span>Research</span>
            <span>Literature search</span>
          </div>
          <h1 class="headline-title">论文检索与 BibTeX 导出</h1>
          <div class="subtitle">
            在浏览器中清晰配置检索式、时间范围与 AI 模型，快速生成结构化 BibTeX 与中文摘要，为综述与论文写作整理高质量参考文献。
          </div>
        </div>

        <div class="layout">
          <section>
            <div class="card">
              <form method="post" id="search-form">
                <div class="section-title"><span>01</span> AI 工具配置</div>
                {% if error %}
                <div class="error">{{ error }}</div>
                {% endif %}

                <div class="form-row">
                  <label for="ai_provider">AI 模型（摘要生成与检索式生成）</label>
                  <select id="ai_provider" name="ai_provider">
                    {% for provider in ai_providers %}
                    <option value="{{ provider.name }}" {% if form.ai_provider == provider.name %}selected{% endif %}>{{ provider.display_name }}</option>
                    {% endfor %}
                  </select>
                  <div class="hint">优先配置和验证 AI 接口，检索式生成与摘要都会调用上方设置的模型。</div>
                </div>

                <div class="form-row">
                  <div id="ai-config-hint" class="hint">根据选择的 AI 模型自动切换配置方式。</div>
                  <div id="gemini-config" class="form-row-inline" style="margin-top: 8px">
                    <div>
                      <input
                        id="gemini_api_key"
                        name="gemini_api_key"
                        type="text"
                        placeholder="Gemini API Key（留空则使用环境变量 GEMINI_API_KEY）"
                        value="{{ form.gemini_api_key }}"
                      />
                    </div>
                    <div>
                      <input id="gemini_model" name="gemini_model" type="text" placeholder="模型名称，默认 gemini-2.5-flash" value="{{ form.gemini_model }}" />
                    </div>
                    <div>
                      <input
                        id="gemini_temperature"
                        name="gemini_temperature"
                        type="number"
                        step="0.1"
                        min="0"
                        max="1"
                        placeholder="温度，默认 0"
                        value="{{ form.gemini_temperature }}"
                      />
                    </div>
                  </div>
                  <div id="openai-config" class="form-row-inline" style="margin-top: 8px; display: none">
                    <div>
                      <input
                        id="openai_api_key"
                        name="openai_api_key"
                        type="text"
                        placeholder="OpenAI API Key（留空则读取环境变量 OPENAI_API_KEY）"
                        value="{{ form.openai_api_key }}"
                      />
                    </div>
                    <div>
                      <input
                        id="openai_base_url"
                        name="openai_base_url"
                        type="text"
                        placeholder="Base URL，兼容自托管 OpenAI 接口"
                        value="{{ form.openai_base_url }}"
                      />
                    </div>
                    <div>
                      <input
                        id="openai_model"
                        name="openai_model"
                        type="text"
                        placeholder="模型名称，默认 gpt-4o-mini"
                        value="{{ form.openai_model }}"
                      />
                    </div>
                    <div>
                      <input
                        id="openai_temperature"
                        name="openai_temperature"
                        type="number"
                        step="0.1"
                        min="0"
                        max="1"
                        placeholder="温度，默认 0"
                        value="{{ form.openai_temperature }}"
                      />
                    </div>
                  </div>
                </div>

                <div class="section-title"><span>02</span> 文献检索与数据源</div>

                <div class="form-row form-row-inline">
                  <div>
                    <label for="source">文献数据源</label>
                    <select id="source" name="source">
                      {% for source in sources %}
                      <option value="{{ source.name }}" {% if form.source == source.name %}selected{% endif %}>{{ source.display_name }}</option>
                      {% endfor %}
                    </select>
                    <div class="hint hint-compact">当前内置 PubMed，后续可扩展其他来源。</div>
                  </div>
                  <div>
                    <label for="years">时间范围（最近几年）</label>
                    <input id="years" name="years" type="number" min="1" max="50" value="{{ form.years }}" />
                  </div>
                </div>

                <div class="form-row">
                  <label for="query">检索式（必填）</label>
                  <textarea
                    id="query"
                    name="query"
                    placeholder="例如：&quot;artificial intelligence&quot; AND (&quot;dental implants&quot; OR &quot;implant dentistry&quot; OR &quot;oral implantology&quot;)"
                  >{{ form.query }}</textarea>
                  <div class="hint">支持 PubMed 常用语法：AND / OR / 括号等。建议先用较宽泛的主题探索，再逐步收窄。</div>
                </div>

                <div class="card card-soft" style="margin-bottom: 14px">
                  <div class="section-title"><span>AI</span> 自动生成检索式</div>
                  <label for="intent">用自然语言描述你要找的文献</label>
                  <textarea
                    id="intent"
                    name="intent"
                    placeholder="例如：想找近五年关于人工智能辅助口腔种植外科规划的综述和随机对照研究"
                  ></textarea>
                  <div class="generator-actions">
                    <button class="btn btn-secondary" id="btn-generate-query">AI 生成检索式</button>
                    <div id="generator-output" class="generator-output">生成的检索式或提示会显示在这里（使用已配置的 AI 真实调用）。</div>
                  </div>
                </div>

                <div class="form-row form-row-inline">
                  <div>
                    <label for="max_results">最大文献条数</label>
                    <input id="max_results" name="max_results" type="number" min="1" max="200" value="{{ form.max_results }}" />
                  </div>
                  <div>
                    <label for="output">导出文件名（可选）</label>
                    <input id="output" name="output" type="text" value="{{ form.output }}" />
                    <div class="hint hint-compact">留空则使用默认文件名（例如：pubmed_results.bib）。</div>
                  </div>
                </div>

                <div class="form-row form-row-inline form-row-optional">
                  <div>
                    <label for="email" class="optional-label">联系邮箱（推荐，PubMed 用）</label>
                    <input id="email" name="email" type="text" placeholder="用于 NCBI E-utilities 合规使用" value="{{ form.email }}" />
                    <div class="hint hint-compact">留空时会为当前请求生成一个随机邮箱，仅用于 PubMed API。</div>
                  </div>
                  <div>
                    <label for="api_key" class="optional-label">API Key（可选，根据数据源填写）</label>
                    <input id="api_key" name="api_key" type="text" placeholder="可选：例如 PubMed 的 NCBI API Key" value="{{ form.api_key }}" />
                  </div>
                </div>

                <textarea id="bibtex-hidden" name="bibtex_text" style="display: none">{{ bibtex_text }}</textarea>

                <div class="form-row" style="display: flex; gap: 10px; align-items: center">
                  <button class="btn btn-primary" type="submit">检索并生成 BibTeX</button>
                  <button class="btn btn-secondary" type="button" id="copy-btn" onclick="copyBibtex()" {% if not bibtex_text %}disabled{% endif %}>复制 BibTeX</button>
                  <button class="btn btn-secondary export-btn" type="submit" formaction="/download" {% if not bibtex_text %}disabled{% endif %}>导出 BibTeX 文件</button>
                </div>
              </form>
            </div>
          </section>

          <section>
            <div class="card card-soft">
              <div class="section-title"><span>状态</span> 运行进度</div>
              <ul class="status-list">
                {% if status_log %}
                {% for item in status_log %}
                <li class="status-item">
                  <span class="status-icon {{ 'success' if item.status == 'success' else 'error' if item.status == 'error' else 'pending' }}">
                    {% if item.status == 'success' %}✓{% elif item.status == 'error' %}!{% else %}…{% endif %}
                  </span>
                  <div class="status-text">
                    <strong>{{ item.step }}</strong>
                    <span>{{ item.detail }}</span>
                  </div>
                </li>
                {% endfor %}
                {% else %}
                <li class="status-item">
                  <span class="status-icon pending">…</span>
                  <div class="status-text">
                    <strong>等待开始</strong>
                    <span>提交表单后会展示检索、AI 调用与导出等进度。</span>
                  </div>
                </li>
                {% endif %}
              </ul>
            </div>

            <div class="card">
              <div class="bibtex-header">
                <div>
                  <div class="section-title"><span>结果</span> BibTeX 输出</div>
                  <span>共 {{ count }} 条记录</span>
                </div>
              </div>
              <textarea id="bibtex-output" class="bibtex-output" rows="18" readonly>{{ bibtex_text }}</textarea>
              <div class="hint">可直接复制到 .bib 文件，或导入 Zotero / EndNote / NoteExpress 等工具。</div>
            </div>

            <div class="card">
              <div class="article-list-title">文献条目</div>
              {% if articles %}
              {% for article in articles %}
              <div class="article">
                <div class="article-title">
                  {% if article.url %}
                  <a href="{{ article.url }}" target="_blank" rel="noreferrer">{{ article.title }}</a>
                  {% else %}
                  {{ article.title }}
                  {% endif %}
                </div>
                <div class="article-meta">{{ article.authors }} · {{ article.journal }} · {{ article.year }} {% if article.pmid %}<span class="badge">PMID: {{ article.pmid }}</span>{% endif %}</div>
                {% if article.abstract %}
                <div class="article-abstract"><span class="article-label">摘要：</span>{{ article.abstract }}</div>
                {% endif %}
                {% if article.summary_zh %}
                <div class="article-summary"><span class="article-summary-label">AI 总结</span>{{ article.summary_zh }}</div>
                {% endif %}
                {% if article.usage_zh %}
                <div class="article-summary article-usage"><span class="article-summary-label">应用建议</span>{{ article.usage_zh }}</div>
                {% endif %}
              </div>
              {% endfor %}
              {% else %}
              <div class="hint">提交后将在此展示检索到的文献列表与 AI 总结。</div>
              {% endif %}
            </div>
          </section>
        </div>

        <div class="footer">
          <span>LOCAL RESEARCH UTILITY</span><br />当前界面仅作为本地学术辅助工具使用：不会上传你的 API Key 或检索式到除必要接口以外的任何服务。
        </div>
      </main>
    </div>

    <script>
      window.sourceDefaults = {{ source_defaults | tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  </body>
</html>
