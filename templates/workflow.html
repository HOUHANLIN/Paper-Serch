{% extends "_base.html" %}

{% block title %}Paper-Serch · 自动工作流{% endblock %}

{% block content %}
  <section class="hero container">
    <div class="hero-text">
      <p class="eyebrow">方向拆解 · 批量整理</p>
      <h1>自动分方向检索与摘要</h1>
      <p class="lede">将长文本一键拆解成多个检索方向，自动生成检索式、获取文献并输出 BibTeX。</p>
    </div>
    {% set placeholder_detail = '提交后在此显示任务分解与抓取进度。' %}
    {% include "_partials/status_module.html" %}
  </section>

  <form id="workflow-form" method="post" class="container workflow-layout">
    <aside class="workflow-settings stack">
      <details class="card settings-collapsible" open>
        <summary class="card-head">
          <div>
            <p class="card-kicker">CONFIGURATION</p>
            <h2>配置与工具</h2>
          </div>
        </summary>

        <div class="settings-content stack">
          {% include "_partials/provider_panels.html" %}

          <hr class="separator" />

          <div class="field">
            <label for="source">文献数据源</label>
            <select id="source" name="source">
              {% for source in sources %}
                <option value="{{ source.name }}" {% if form.source==source.name %}selected{% endif %}>{{ source.display_name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="field">
            <label for="direction_count">主题数量</label>
            <input id="direction_count" name="direction_count" type="number" min="1" max="12" value="5" />
            <p class="muted" style="margin: 6px 0 0;">指定自动拆解成多少个检索主题（方向）。</p>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="years">年份</label>
              <input id="years" name="years" type="number" min="1" max="50" value="{{ form.years }}" />
            </div>
            <div class="field">
              <label for="max_results">条数/方向</label>
              <input id="max_results" name="max_results" type="number" min="1" max="50" value="{{ form.max_results or 5 }}" />
            </div>
          </div>

          <div class="field">
            <label class="switch">
              <input type="checkbox" id="toggle-contact" />
              <span>高级参数 (Email/API/并发)</span>
            </label>
          </div>

          <div id="contact-fields" style="display:none;" class="stack">
            <div class="field"><label for="email">联系邮箱</label><input id="email" name="email" type="text" value="{{ form.email }}" /></div>
            <div class="field"><label for="api_key">API Key</label><input id="api_key" name="api_key" type="text" value="{{ form.api_key }}" /></div>
            <div class="field">
              <label for="concurrency">PubMed 并发</label>
              <input id="concurrency" name="concurrency" type="number" min="1" max="50" value="3" />
              <p class="muted" style="margin: 6px 0 0;">限制 PubMed HTTP 请求并发（方向本身不限制并发）。</p>
            </div>
          </div>
        </div>
      </details>
    </aside>

    <div class="workflow-main stack">
      <div class="card workspace-card">
        <div class="card-head">
          <div>
            <p class="card-kicker">WORKSPACE</p>
            <h2>拆解内容并检索</h2>
          </div>
        </div>
        <div class="field">
          <textarea id="direction-text" name="direction_text" placeholder="粘贴研究背景或说明文字，AI 将自动拆解方向并检索..." class="large-input"></textarea>
        </div>
        <div class="generator-actions">
          <button class="btn primary" id="btn-auto-workflow" type="button">一键拆解并检索</button>
          <div class="direction-output">
            <p class="muted" id="direction-message">等待输入以自动拆解检索方向。</p>
            <ul id="direction-list" class="direction-list"></ul>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <p class="card-kicker">PAPERS</p>
            <h2>文献列表</h2>
          </div>
        </div>
        <div id="direction-results" class="stack">
          <div class="muted">运行后将按检索点分组展示文献。</div>
        </div>
      </div>

      {% set bibtex_form_id = 'workflow-form' %}
      {% set card_classes = 'card bibtex-consolidated glass' %}
      {% include "_partials/bibtex_card.html" %}
    </div>
  </form>

  <footer class="footer">
    <div class="container">
      <p class="muted">WORKFLOW PREVIEW</p>
      <p>自动拆解、检索与摘要生成均在本地请求链路内执行，不保存输入内容。</p>
    </div>
  </footer>
{% endblock %}
