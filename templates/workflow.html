<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <title>Paper-Serch · 自动工作流</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script>
      (() => {
        const saved = localStorage.getItem('ps-theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.dataset.theme = saved || (prefersDark ? 'dark' : 'light');
      })();
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <a href="{{ url_for('index') }}" class="brand-mark">
          <span class="dot"></span>
          <div>
            <div class="brand-sub">Paper-Serch</div>
            <div class="brand-title">Literature &amp; AI summaries</div>
          </div>
        </a>
        <nav class="nav-links">
          <a href="{{ url_for('index') }}">首页</a>
          <a href="{{ url_for('workflow') }}" aria-current="page">自动工作流</a>
          <a href="{{ url_for('tutorial') }}">使用教程</a>
        </nav>
      </div>
    </header>

        <main class="page">
          <section class="hero container">
        <div class="hero-text">
          <p class="eyebrow">方向拆解 · 批量整理</p>
          <h1>自动分方向检索与摘要</h1>
          <p class="lede">将长文本一键拆解成多个检索方向，自动生成检索式、获取文献并输出 BibTeX。</p>
        </div>
        <div class="hero-panel">
          <div class="metric">
            <div class="metric-label">最近检索默认</div>
            <div class="metric-value">{{ form.years or 5 }}</div>
            <div class="metric-desc">最近年份</div>
          </div>
          <div class="metric">
            <div class="metric-label">每个方向默认</div>
            <div class="metric-value">{{ form.max_results or 5 }}</div>
            <div class="metric-desc">条文献</div>
          </div>
          <div class="metric">
            <div class="metric-label">导出文件名</div>
            <div class="metric-value">{{ form.output or "pubmed_results.bib" }}</div>
            <div class="metric-desc">可自定义</div>
          </div>
        </div>
      </section>

      <div class="container grid">
        <form id="workflow-form" class="stack" method="post">
          <div class="card">
            <div class="card-head">
              <div>
                <p class="card-kicker">TOOLS</p>
                <h2>AI 工具与配置</h2>
              </div>
            </div>
            <div class="field-group">
              <label for="ai_provider">选择 AI 模型</label>
              <select id="ai_provider" name="ai_provider">
                {% for provider in ai_providers %}
                <option value="{{ provider.name }}" {% if form.ai_provider == provider.name %}selected{% endif %}>{{ provider.display_name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="provider-panel" data-provider="ollama">
              <div class="field-inline">
                <label for="ollama_api_key">Ollama API Key</label>
                <input id="ollama_api_key" name="ollama_api_key" type="text" value="{{ form.ollama_api_key }}" placeholder="默认 ollama" />
              </div>
              <div class="field-inline">
                <label for="ollama_base_url">Base URL</label>
                <input id="ollama_base_url" name="ollama_base_url" type="text" value="{{ form.ollama_base_url }}" placeholder="默认 http://localhost:11434/v1" />
              </div>
              <div class="field-inline">
                <label for="ollama_model">模型名称</label>
                <input id="ollama_model" name="ollama_model" type="text" value="{{ form.ollama_model }}" placeholder="默认 llama3.1" />
              </div>
              <div class="field-inline">
                <label for="ollama_temperature">温度</label>
                <input id="ollama_temperature" name="ollama_temperature" type="number" step="0.1" min="0" max="1" value="{{ form.ollama_temperature }}" placeholder="默认 0" />
              </div>
            </div>
            <div class="provider-panel" data-provider="openai">
              <div class="field-inline">
                <label for="openai_api_key">OpenAI API Key</label>
                <input id="openai_api_key" name="openai_api_key" type="text" value="{{ form.openai_api_key }}" placeholder="留空读取 OPENAI_API_KEY" />
              </div>
              <div class="field-inline">
                <label for="openai_base_url">Base URL</label>
                <input id="openai_base_url" name="openai_base_url" type="text" value="{{ form.openai_base_url }}" placeholder="兼容自托管接口" />
              </div>
              <div class="field-inline">
                <label for="openai_model">模型名称</label>
                <input id="openai_model" name="openai_model" type="text" value="{{ form.openai_model }}" placeholder="默认 gpt-4o-mini" />
              </div>
              <div class="field-inline">
                <label for="openai_temperature">温度</label>
                <input id="openai_temperature" name="openai_temperature" type="number" step="0.1" min="0" max="1" value="{{ form.openai_temperature }}" placeholder="默认 0" />
              </div>
            </div>
            <div class="provider-panel" data-provider="gemini">
              <div class="field-inline">
                <label for="gemini_api_key">Gemini API Key</label>
                <input id="gemini_api_key" name="gemini_api_key" type="text" value="{{ form.gemini_api_key }}" placeholder="留空读取 GEMINI_API_KEY" />
              </div>
              <div class="field-inline">
                <label for="gemini_model">模型名称</label>
                <input id="gemini_model" name="gemini_model" type="text" value="{{ form.gemini_model }}" placeholder="默认 gemini-2.5-flash" />
              </div>
              <div class="field-inline">
                <label for="gemini_temperature">温度</label>
                <input id="gemini_temperature" name="gemini_temperature" type="number" step="0.1" min="0" max="1" value="{{ form.gemini_temperature }}" placeholder="默认 0" />
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-head">
              <div>
                <p class="card-kicker">WORKFLOW</p>
                <h2>自动分方向检索</h2>
              </div>
              <label class="switch">
                <input type="checkbox" id="toggle-contact" />
                <span>显示 PubMed 邮箱/API</span>
              </label>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="source">文献数据源</label>
                <select id="source" name="source">
                  {% for source in sources %}
                  <option value="{{ source.name }}" {% if form.source == source.name %}selected{% endif %}>{{ source.display_name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="field">
                <label for="years">时间范围（最近几年）</label>
                <input id="years" name="years" type="number" min="1" max="50" value="{{ form.years }}" />
              </div>
              <div class="field">
                <label for="max_results">每个方向最大条数</label>
                <input id="max_results" name="max_results" type="number" min="1" max="50" value="{{ form.max_results or 5 }}" />
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label for="output">导出文件名（可选）</label>
                <input id="output" name="output" type="text" value="{{ form.output }}" placeholder="默认使用数据源建议" />
              </div>
              <div class="field" id="contact-fields">
                <label class="optional" for="email">联系邮箱（可选）</label>
                <input id="email" name="email" type="text" value="{{ form.email }}" placeholder="用于 PubMed 合规" />
                <label class="optional" for="api_key">API Key（可选）</label>
                <input id="api_key" name="api_key" type="text" value="{{ form.api_key }}" placeholder="NCBI API Key" />
              </div>
            </div>
            <div class="field">
              <label for="direction-text">拆解内容</label>
              <textarea id="direction-text" name="direction_text" placeholder="粘贴文章或说明文字，自动拆解方向并检索"></textarea>
            </div>
            <div class="generator">
              <button class="btn primary" id="btn-auto-workflow" type="button">一键拆解并检索</button>
            <div class="direction-output">
              <p class="muted" id="direction-message">等待输入以自动拆解检索方向。</p>
              <ul id="direction-list" class="direction-list"></ul>
            </div>
          </div>
        </div>

        <div class="card actions">
          <div class="actions-left">
            <p class="card-kicker">EXPORT</p>
              <h3>导出与复制</h3>
            </div>
            <div class="actions-right">
              <button class="btn ghost" type="button" id="copy-btn" {% if not bibtex_text %}disabled{% endif %}>复制 BibTeX</button>
              <button class="btn subtle export-btn" type="submit" formaction="/download" {% if not bibtex_text %}disabled{% endif %}>导出 BibTeX 文件</button>
            </div>
            <textarea id="bibtex-hidden" name="bibtex_text" hidden>{{ bibtex_text }}</textarea>
          </div>
        </form>

        <section class="stack">
          <div class="card status-card">
            <div class="status-head">
              <div>
                <p class="card-kicker">STATUS</p>
                <h2>运行进度</h2>
              </div>
              <div class="runtime" id="runtime" data-tone="idle">
                <span class="dot"></span>
                <div>
                  <div id="runtime-state">等待开始</div>
                  <div class="muted" id="runtime-elapsed">00:00</div>
                </div>
              </div>
            </div>
            <ul class="status-list" id="status-list">
              <li class="status-item" id="status-placeholder">
                <span class="status-icon pending">…</span>
                <div>
                  <strong>等待开始</strong>
                  <p class="muted">拆解、检索与摘要的进度会集中显示在这里。</p>
                </div>
              </li>
            </ul>
          </div>

          <div class="card">
            <div class="card-head">
              <div>
                <p class="card-kicker">DIRECTIONS</p>
                <h2>检索点与文献分组</h2>
              </div>
            </div>
            <div id="direction-results" class="article-list">
              <div class="muted">运行后将在此按检索点分组展示文献。</div>
            </div>
          </div>

          <div class="card">
            <div class="card-head">
              <div>
                <p class="card-kicker">RESULT</p>
                <h2>BibTeX 输出</h2>
              </div>
              <span class="muted" id="result-count">共 {{ count }} 条记录</span>
            </div>
            <textarea id="bibtex-output" class="bibtex-output" rows="16" readonly>{{ bibtex_text }}</textarea>
          </div>
        </section>
      </div>

      <footer class="footer">
        <div class="container">
          <p class="muted">WORKFLOW PREVIEW</p>
          <p>自动拆解、检索与摘要生成均在本地请求链路内执行，不保存输入内容。</p>
        </div>
      </footer>
    </main>

    <script>
      window.sourceDefaults = {{ source_defaults | tojson }};
      window.initialStatusLog = {{ status_log | tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  </body>
</html>
