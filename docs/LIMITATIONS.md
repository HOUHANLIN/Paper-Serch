# 当前不足与改进建议

本项目以“本地快速检索 + BibTeX 导出 + 可选 AI 中文总结”为目标，当前版本已经可用，但在高并发、长任务与可维护性方面仍有一些明显短板。本文档用于把这些不足显式化，方便后续迭代与排查。

## 1) 自动工作流（/workflow）

### 1.1 长任务的可靠性
- SSE 任务目前缺少全局超时/看门狗机制；如果某方向线程在网络层卡死，可能导致整个工作流 SSE 不结束（建议为 worker/队列加超时与失败收敛）。
- 缺少任务取消（cancel）与断点续跑（resume）；刷新页面或网络中断后，需要重新跑一次。

### 1.2 并发策略的风险
- 方向并发目前“不限制”，可能创建大量线程；在方向很多或机器资源有限时会造成 CPU/内存压力与响应延迟。
- AI 摘要并发默认“不限制”（每篇文章一个并发调用），在文献数量大时会把本机并发和第三方接口配额拉满，导致失败率上升或被限流。
- 前端“PubMed 并发”只控制 PubMed HTTP 请求并发，不等同于整体工作流并发；建议在页面上给出更明确的提示和推荐区间。

### 1.3 结果质量与可用性
- 跨方向的重复文献目前不会自动去重，最终合并 BibTeX 可能重复、计数也会偏大（建议 DOI/PMID/标题归一化去重）。
- 工作流进度展示沿用了单次检索的 4 步进度模型，面对多方向时信息密度过高；建议增加“已完成方向数/总方向数”的工作流专属进度。

## 2) PubMed 数据源

### 2.1 速率限制与失败场景
已对 `429/5xx/超时/连接失败` 做了重试与退避，但仍需注意：
- PubMed（NCBI E-utilities）对高频请求敏感；并发过高会触发 429，导致整体变慢或失败。
- 需要更体系化的“限速策略”（比如按是否提供 API key 区分默认速率、加入更可控的节流/队列）。

### 2.2 可观测性与诊断
- 当前主要靠前端状态日志 + 后端异常信息；建议引入结构化日志（请求耗时、重试次数、状态码、方向/检索式）以便排查。

## 3) AI 调用（检索式/方向拆解/摘要）

### 3.1 配额与成本风险
- 并发放开后，成本与限流风险显著增加；建议提供“并发上限/总预算/失败重试策略”的可配置项与 UI 提示。
- AI 摘要是一篇文章一次调用；可以考虑批处理（多篇合并）或按用户选择启用/按摘要长度裁剪以降低成本。

### 3.2 隐私与安全
- API Key 允许在页面输入；项目默认不持久化，但仍建议：
  - 默认引导使用 `.env`；
  - 明确提示“不要在公共环境输入密钥”；
  - 确保日志与错误信息不回显敏感字段。

## 4) 工程化与维护

### 4.1 测试与回归
- 缺少自动化测试（尤其是：PubMed 解析、BibTeX 生成、工作流事件格式）。
- 建议至少补充：单元测试（解析/格式化）+ 少量集成测试（mock 外部请求）。

### 4.2 配置文档
- 已存在多处并发/重试相关配置（PubMed、AI），建议集中成一份“运行参数手册”，避免用户靠读源码理解。

